name: Main Deploy

on:
  push:
    branches:
      - 'main'

jobs:
  install:
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout Repo
        uses: actions/checkout@v2

      - name: Node Installer
        uses: actions/setup-node@v2
        with:
            node-version: '14'

      - name: Install npm packages
        uses: bahmutov/npm-install@v1

  test:
    needs: 'install'
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout Repo
        uses: actions/checkout@v2
      
      - name: Node Installer
        uses: actions/setup-node@v2
        with:
            node-version: '14'

      - name: Install npm packages
        uses: bahmutov/npm-install@v1
        with:
          working-directory: |
            src
            repo-secure
            
      - name: Run Tests
        run: npm run lint
        working-directory: repo-secure
        
  deploy:
    needs: 'test'
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout Repo
        uses: actions/checkout@v2

      - name: Node Installer
        uses: actions/setup-node@v2
        with:
            node-version: '14'

      - name: Install npm packages
        uses: bahmutov/npm-install@v1

      - name: üöÄ CDK Deploy
        env:
          AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY_ID}}
          AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}
          GH_APP_ID: ${{secrets.GH_APP_ID}}
          GH_REPOSECURE_PK: ${{secrets.GH_REPOSECURE_PK}}
          GH_REPOSECURE_WEBHOOK: ${{secrets.GH_REPOSECURE_WEBHOOK}}
        run: |
          npm i -g aws-cdk
          cdk synth
          cdk deploy --all --require-approval never